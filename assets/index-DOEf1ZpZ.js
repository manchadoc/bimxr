import*as s from"https://cdn.skypack.dev/three@0.128.0";import{GLTFLoader as F}from"https://cdn.skypack.dev/three@0.128.0/examples/jsm/loaders/GLTFLoader.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))n(e);new MutationObserver(e=>{for(const t of e)if(t.type==="childList")for(const a of t.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function i(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?t.credentials="include":e.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function n(e){if(e.ep)return;e.ep=!0;const t=i(e);fetch(e.href,t)}})();async function E(){const f=new F;let r;f.load("https://immersive-web.github.io/webxr-samples/media/gltf/reticle/reticle.gltf",function(l){r=l.scene,r.visible=!1,t.add(r)});let i;f.load("https://github.com/manchadoc/bimxr/blob/main/public/assets/model.glb",function(l){i=l.scene,i.scale.set(.1,.1,.1)});const n=document.createElement("canvas");document.body.appendChild(n);const e=n.getContext("webgl",{xrCompatible:!0}),t=new s.Scene,a=new s.DirectionalLight(16777215,.3);a.position.set(10,15,10),t.add(a);const u=new s.WebGLRenderer({alpha:!0,preserveDrawingBuffer:!0,canvas:n,context:e});u.autoClear=!1;const c=new s.PerspectiveCamera;c.matrixAutoUpdate=!1;const o=await navigator.xr.requestSession("immersive-ar",{requiredFeatures:["hit-test"]});o.updateRenderState({baseLayer:new XRWebGLLayer(o,e)});const g=await o.requestReferenceSpace("local"),v=await o.requestReferenceSpace("viewer"),L=await o.requestHitTestSource({space:v}),x=new s.MeshBasicMaterial({color:"#ecff33"}),S=new s.BoxGeometry,R=new s.Mesh(S,x);t.add(R),o.addEventListener("select",l=>{if(i){console.log(i.position);const d=i.clone();d.position.copy(r.position),t.add(d)}});const h=(l,d)=>{o.requestAnimationFrame(h),e.bindFramebuffer(e.FRAMEBUFFER,o.renderState.baseLayer.framebuffer);const w=d.getViewerPose(g);if(w){const m=w.views[0],b=o.renderState.baseLayer.getViewport(m);u.setSize(b.width,b.height),c.matrix.fromArray(m.transform.matrix),c.projectionMatrix.fromArray(m.projectionMatrix),c.updateMatrixWorld(!0);const y=d.getHitTestResults(L);if(y.length>0&&r){const p=y[0].getPose(g);r.visible=!0,r.position.set(p.transform.position.x,p.transform.position.y,p.transform.position.z),r.updateMatrixWorld(!0)}u.render(t,c)}};o.requestAnimationFrame(h)}document.getElementById("fetchButton").addEventListener("click",()=>{E()});
